import os
import yaml
from ultralytics import YOLO
import torch
from pathlib import Path


def train_improved_yolo11(data_yaml_path, model_size='n', epochs=100, imgsz=640):
    """
    ê°œì„ ëœ YOLO11 ëª¨ë¸ í›ˆë ¨ (ë°°ê²½ ë‹¤ì–‘í™” ë° ì„±ëŠ¥ ì¤‘ì‹¬)

    Args:
        data_yaml_path: ë°ì´í„° ì„¤ì • íŒŒì¼ ê²½ë¡œ  
        model_size: ëª¨ë¸ í¬ê¸° ('n', 's', 'm', 'l', 'x') - ì„±ëŠ¥ì„ ìœ„í•´ në¶€í„° ì‹œì‘
        epochs: í›ˆë ¨ ì—í¬í¬ ìˆ˜
        imgsz: ì…ë ¥ ì´ë¯¸ì§€ í¬ê¸°
    """

    print("ğŸš€ ê°œì„ ëœ YOLO11 ëª¨ë¸ í›ˆë ¨ ì‹œì‘... (ë°°ê²½ ë‹¤ì–‘í™” ì ìš©)")
    print(f"ğŸ“± ëª¨ë¸ í¬ê¸°: YOLO11{model_size}")
    print(f"ğŸ”„ ì—í¬í¬: {epochs}")
    print(f"ğŸ“ ì´ë¯¸ì§€ í¬ê¸°: {imgsz}x{imgsz}")

    # ëª¨ë¸ ë¡œë“œ (ì‚¬ì „ í›ˆë ¨ëœ COCO ëª¨ë¸ì„ ê¸°ë°˜ìœ¼ë¡œ ì‹œì‘)
    print(f"ğŸ“¥ YOLO11{model_size} ì‚¬ì „ í›ˆë ¨ ëª¨ë¸ ë¡œë“œ ì¤‘...")
    model = YOLO(f'yolo11{model_size}.pt')

    # GPU ì‚¬ìš© ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
    device = 'cuda' if torch.cuda.is_available() else 'cpu'
    print(f"ğŸ’» í›ˆë ¨ ë””ë°”ì´ìŠ¤: {device}")

    if device == 'cuda':
        print(f"ğŸ® GPU ì •ë³´: {torch.cuda.get_device_name()}")
        print(f"ğŸ’¾ GPU ë©”ëª¨ë¦¬: {torch.cuda.get_device_properties(0).total_memory / 1024 ** 3:.1f}GB")
        # GPU ë©”ëª¨ë¦¬ ì •ë¦¬
        torch.cuda.empty_cache()

    # ë°°ì¹˜ í¬ê¸° GT 1030 ìµœì í™” (2GB VRAM)
    if model_size == 'n':
        batch_size = 8   # nanoëŠ” 8ë¡œ ì œí•œ (GT 1030 ê³ ë ¤)
    elif model_size == 's':
        batch_size = 4   # smallì€ 4
    else:
        batch_size = 2   # medium ì´ìƒì€ 2
    
    print(f"ğŸ“¦ ë°°ì¹˜ í¬ê¸°: {batch_size}")

    # ëª¨ë¸ í›ˆë ¨
    print("\n" + "=" * 70)
    print("ğŸ¯ ëª¨ë¸ í›ˆë ¨ ì‹œì‘! (ë°°ê²½ ë‹¤ì–‘í™” & ì„±ëŠ¥ ìµœì í™” ì„¤ì •)")
    print("=" * 70)

    results = model.train(
        data=data_yaml_path,
        epochs=epochs,
        imgsz=imgsz,
        device=device,
        batch=batch_size,
        patience=50,  # ë°°ê²½ ë‹¤ì–‘í™”ë¡œ ì¸í•œ í•™ìŠµ ì•ˆì •ì„±ì„ ìœ„í•´ patience ì¦ê°€
        save=True,
        project='snack_detection',
        name=f'yolo11{model_size}_background_improved',
        exist_ok=True,
        
        # ========== í•™ìŠµë¥  ìµœì í™” ==========
        lr0=0.008,           # ì´ˆê¸° í•™ìŠµë¥  ì•½ê°„ ê°ì†Œ (ë°°ê²½ ë‹¤ì–‘í™” ê³ ë ¤)
        lrf=0.01,            # ìµœì¢… í•™ìŠµë¥ 
        momentum=0.937,      # ëª¨ë©˜í…€
        weight_decay=0.0005, # ê°€ì¤‘ì¹˜ ê°ì†Œ ì¡°ì •
        warmup_epochs=5,     # ì›Œë°ì—… ì—í¬í¬ ì¦ê°€ (ë°°ê²½ ë‹¤ì–‘í™”ë¡œ ì¸í•œ ì´ˆê¸° ë¶ˆì•ˆì •ì„± ê³ ë ¤)
        warmup_momentum=0.8,
        warmup_bias_lr=0.1,
        
        # ========== ë°°ê²½ ë‹¤ì–‘í™”ë¥¼ ìœ„í•œ ê°•í™”ëœ ë°ì´í„° ì¦ê°• ==========
        
        # 1. ìƒ‰ìƒ ë³€í™” ì¦ê°€ (í°ìƒ‰ ë°°ê²½ ê·¹ë³µ)
        hsv_h=0.03,          # ìƒ‰ìƒ ë³€í™” ì¦ê°€ (0.015 â†’ 0.03)
        hsv_s=0.9,           # ì±„ë„ ë³€í™” ì¦ê°€ (0.7 â†’ 0.9) - ë°°ê²½ ìƒ‰ìƒ ë‹¤ì–‘í™”
        hsv_v=0.6,           # ëª…ë„ ë³€í™” ì¦ê°€ (0.4 â†’ 0.6) - ì¡°ëª… ë‹¤ì–‘í™”
        
        # 2. ê¸°í•˜í•™ì  ë³€í™˜ ê°•í™”
        degrees=15.0,        # íšŒì „ ê°ë„ ì¦ê°€ (10.0 â†’ 15.0)
        translate=0.2,       # ì´ë™ ë³€í™˜ ì¦ê°€ (0.1 â†’ 0.2) - ë°°ê²½ ë…¸ì¶œ ë‹¤ì–‘í™”
        scale=0.8,           # ìŠ¤ì¼€ì¼ ë³€í™” ì¦ê°€ (0.5 â†’ 0.8) - ë°°ê²½ í¬ê¸° ë‹¤ì–‘í™”
        shear=3.0,           # ì „ë‹¨ ë³€í™˜ ì¦ê°€ (2.0 â†’ 3.0)
        perspective=0.0002,  # ì›ê·¼ ë³€í™˜ í™œì„±í™” (ë°°ê²½ ì™œê³¡ íš¨ê³¼)
        flipud=0.1,          # ìƒí•˜ ë°˜ì „ í™œì„±í™” (ë°°ê²½ íŒ¨í„´ ë‹¤ì–‘í™”)
        fliplr=0.5,          # ì¢Œìš° ë°˜ì „ ìœ ì§€
        
        # 3. ê³ ê¸‰ ì¦ê°• ê¸°ë²• í™œì„±í™” (ë°°ê²½ ë‹¤ì–‘í™” í•µì‹¬)
        mosaic=1.0,          # ëª¨ìì´í¬ ìœ ì§€ (ë‹¤ì–‘í•œ ë°°ê²½ ì¡°í•©)
        mixup=0.2,           # ë¯¹ìŠ¤ì—… í™œì„±í™” (ë°°ê²½ í˜¼í•© íš¨ê³¼)
        copy_paste=0.1,      # ë³µì‚¬-ë¶™ì—¬ë„£ê¸° í™œì„±í™” (ë°°ê²½ ë‹¤ì–‘í™”)
        
        # 4. ë…¸ì´ì¦ˆ ë° ë¸”ëŸ¬ íš¨ê³¼ (ë°°ê²½ ë³µì¡ë„ ì¦ê°€)
        # YOLOv8ì—ì„œ ì§ì ‘ ì§€ì›í•˜ì§€ ì•ŠëŠ” ê¸°ëŠ¥ë“¤ì€ ì œê±°
        
        # 5. ì •ê·œí™” ì¡°ì • (ê³¼ì í•© ë°©ì§€)
        dropout=0.1,         # ë“œë¡­ì•„ì›ƒ í™œì„±í™” (ë°°ê²½ ê³¼ì í•© ë°©ì§€)
        
        # 6. ëª¨ë‹ˆí„°ë§ ë° ì €ì¥
        plots=True,          # í”Œë¡¯ ìƒì„± í™œì„±í™”
        save_period=5,       # 5 ì—í¬í¬ë§ˆë‹¤ ì²´í¬í¬ì¸íŠ¸ ì €ì¥ (ë°°ê²½ ë‹¤ì–‘í™” íš¨ê³¼ ëª¨ë‹ˆí„°ë§)
        val=True,            # ê²€ì¦ í™œì„±í™”
        verbose=True,        # ìƒì„¸ ë¡œê·¸
        
        # 7. ì„±ëŠ¥ ìµœì í™”
        amp=True,            # Automatic Mixed Precision ì‚¬ìš©
        fraction=1.0,        # ì „ì²´ ë°ì´í„° ì‚¬ìš©
        
        # 8. ê¸°íƒ€ ì„¤ì •
        rect=False,          # ì§ì‚¬ê°í˜• í›ˆë ¨ ë¹„í™œì„±í™” (ë°°ê²½ ë‹¤ì–‘í™”ë¥¼ ìœ„í•´)
        cos_lr=True,         # ì½”ì‚¬ì¸ í•™ìŠµë¥  ìŠ¤ì¼€ì¤„ëŸ¬
        close_mosaic=15,     # ë§ˆì§€ë§‰ 15 ì—í¬í¬ì—ì„œ ëª¨ìì´í¬ ë¹„í™œì„±í™” (ì•ˆì •í™”)
        
        # 9. NMS ì„¤ì •
        iou=0.65,            # IoU threshold ì•½ê°„ ê°ì†Œ (ë°°ê²½ ë‹¤ì–‘í™”ë¡œ ì¸í•œ false positive ê³ ë ¤)
        
        # 10. ì¶”ê°€ ì„¤ì •
        single_cls=False,    # ë‹¤ì¤‘ í´ë˜ìŠ¤ ì‚¬ìš©
        overlap_mask=True,   # ë§ˆìŠ¤í¬ ê²¹ì¹¨ í—ˆìš© (ë³µì¡í•œ ë°°ê²½ ì²˜ë¦¬)
        mask_ratio=4,        # ë§ˆìŠ¤í¬ ë‹¤ìš´ìƒ˜í”Œë§ ë¹„ìœ¨
        
        # 11. í•™ìŠµ ì•ˆì •ì„± í–¥ìƒ
        erasing=0.4,         # ëœë¤ ì§€ìš°ê¸° (ë°°ê²½ ì˜ì¡´ì„± ê°ì†Œ)
        crop_fraction=1.0,   # ì „ì²´ ì´ë¯¸ì§€ ì‚¬ìš©
    )

    print("\n" + "=" * 70)
    print("ğŸ‰ í›ˆë ¨ ì™„ë£Œ! (ë°°ê²½ ë‹¤ì–‘í™” ì ìš©)")
    print("=" * 70)

    # ëª¨ë¸ ê²€ì¦
    print("ğŸ“Š ëª¨ë¸ ê²€ì¦ ì¤‘...")
    metrics = model.val()

    print(f"\nğŸ“ˆ ìµœì¢… ì„±ëŠ¥ ê²°ê³¼:")
    print(f"  - mAP50: {metrics.box.map50:.4f} ({metrics.box.map50*100:.1f}%)")
    print(f"  - mAP50-95: {metrics.box.map:.4f} ({metrics.box.map*100:.1f}%)")
    print(f"  - Precision: {metrics.box.mp:.4f} ({metrics.box.mp*100:.1f}%)")
    print(f"  - Recall: {metrics.box.mr:.4f} ({metrics.box.mr*100:.1f}%)")

    # ì„±ëŠ¥ í‰ê°€ (ë°°ê²½ ë‹¤ì–‘í™” ê³ ë ¤)
    target_map50 = 0.25  # ë°°ê²½ ë‹¤ì–‘í™”ë¡œ ì¸í•œ ì´ˆê¸° ì„±ëŠ¥ ì €í•˜ ê³ ë ¤í•˜ì—¬ 25%ë¡œ ì¡°ì •
    print(f"\nğŸ¯ ì„±ëŠ¥ í‰ê°€ (ë°°ê²½ ë‹¤ì–‘í™” ì ìš©):")
    if metrics.box.map50 >= target_map50:
        print(f"âœ… ëª©í‘œ ë‹¬ì„±! mAP50 {metrics.box.map50:.3f} >= {target_map50}")
        print("ğŸš€ ë°°ê²½ ë‹¤ì–‘í™” ì„±ê³µ! ë‹¤ì–‘í•œ í™˜ê²½ì—ì„œ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥!")
    elif metrics.box.map50 >= 0.15:
        print(f"âš ï¸  ê°œì„  í•„ìš”: mAP50 {metrics.box.map50:.3f} (ëª©í‘œ: {target_map50})")
        print("ğŸ’¡ ë°°ê²½ ë‹¤ì–‘í™” ì´ˆê¸° ë‹¨ê³„ - ë” ë§ì€ ì—í¬í¬ í•„ìš”")
    else:
        print(f"âŒ ì„±ëŠ¥ ë¶€ì¡±: mAP50 {metrics.box.map50:.3f} < 0.15")
        print("ğŸ”§ ë°ì´í„° í’ˆì§ˆ í™•ì¸ ë˜ëŠ” ë°°ê²½ ë‹¤ì–‘í™” ì •ë„ ì¡°ì • í•„ìš”")

    # ë°°ê²½ ë‹¤ì–‘í™” íš¨ê³¼ ë¶„ì„
    print(f"\nğŸ¨ ë°°ê²½ ë‹¤ì–‘í™” íš¨ê³¼:")
    print(f"  - ìƒ‰ìƒ ë³€í™”: HSV ì¦ê°• ê°•í™” ì ìš©")
    print(f"  - ê¸°í•˜í•™ì  ë³€í™˜: íšŒì „, ì´ë™, ìŠ¤ì¼€ì¼ ì¦ê°€")
    print(f"  - ê³ ê¸‰ ì¦ê°•: ëª¨ìì´í¬, ë¯¹ìŠ¤ì—…, ë³µì‚¬-ë¶™ì—¬ë„£ê¸° í™œì„±í™”")
    print(f"  - ì •ê·œí™”: ë“œë¡­ì•„ì›ƒ 0.1, ëœë¤ ì§€ìš°ê¸° 0.4 ì ìš©")

    print(f"\nğŸ’¾ ì €ì¥ëœ ëª¨ë¸ ìœ„ì¹˜:")
    print(f"   ğŸ“ í”„ë¡œì íŠ¸: snack_detection/yolo11{model_size}_background_improved/")
    print(f"   ğŸ† Best: weights/best.pt")
    print(f"   ğŸ“‹ Last: weights/last.pt")
    print(f"   ğŸ“Š Results: results.csv")
    print(f"   ğŸ–¼ï¸  ì´ë¯¸ì§€: train_batch*.jpg, val_batch*.jpg (5 ì—í¬í¬ë§ˆë‹¤)")
    print(f"   ğŸ“ˆ ê·¸ë˜í”„: results.png, confusion_matrix.png")

    print(f"\nğŸ” ë‹¤ìŒ ë‹¨ê³„ ì¶”ì²œ:")
    print(f"1. í›ˆë ¨ ì´ë¯¸ì§€ í™•ì¸: train_batch*.jpgì—ì„œ ë°°ê²½ ë‹¤ì–‘í™” í™•ì¸")
    print(f"2. ë‹¤ì–‘í•œ ë°°ê²½ì—ì„œ í…ŒìŠ¤íŠ¸ (í°ìƒ‰ ì™¸ ë°°ê²½)")
    print(f"3. ì„±ëŠ¥ì´ ë¶€ì¡±í•˜ë©´ ë” ë§ì€ ë°°ê²½ ë°ì´í„° ìˆ˜ì§‘")
    print(f"4. ì‹¤ì œ í™˜ê²½ê³¼ ìœ ì‚¬í•œ ë°°ê²½ì—ì„œ ì¶”ê°€ ê²€ì¦")

    return model, results

# ë°°ê²½ ë‹¤ì–‘í™”ë¥¼ ìœ„í•œ ì¶”ê°€ ë„êµ¬ í•¨ìˆ˜
def analyze_background_diversity(image_folder):
    """
    ì´ë¯¸ì§€ í´ë”ì˜ ë°°ê²½ ë‹¤ì–‘ì„± ë¶„ì„
    """
    print("ğŸ” ë°°ê²½ ë‹¤ì–‘ì„± ë¶„ì„ ì¤‘...")
    # ì‹¤ì œ êµ¬í˜„ì€ OpenCV ë“±ì„ ì‚¬ìš©í•˜ì—¬ ë°°ê²½ ìƒ‰ìƒ ë¶„í¬ ë¶„ì„
    print("ğŸ’¡ ë³„ë„ ìŠ¤í¬ë¦½íŠ¸ë¡œ ë°°ê²½ ìƒ‰ìƒ íˆìŠ¤í† ê·¸ë¨ ë¶„ì„ì„ ì¶”ì²œí•©ë‹ˆë‹¤.")

def suggest_background_augmentation():
    """
    ë°°ê²½ ë‹¤ì–‘í™” ë°©ë²• ì œì•ˆ
    """
    print("\nğŸ¨ ë°°ê²½ ë‹¤ì–‘í™” ì¶”ê°€ ë°©ë²•:")
    print("1. ì‹¤ì œ í™˜ê²½ ë°ì´í„° ìˆ˜ì§‘ (ë‹¤ì–‘í•œ í…Œì´ë¸”, ì„ ë°˜ ë“±)")
    print("2. ë°°ê²½ êµì²´ ë„êµ¬ ì‚¬ìš© (remove.bg + ìƒˆ ë°°ê²½ í•©ì„±)")
    print("3. ì¡°ëª… ì¡°ê±´ ë‹¤ì–‘í™” (ìì—°ê´‘, ì‹¤ë‚´ë“±, í˜•ê´‘ë“± ë“±)")
    print("4. í…ìŠ¤ì²˜ ë°°ê²½ ì¶”ê°€ (ë‚˜ë¬´, ì²œ, í”Œë¼ìŠ¤í‹± ë“±)")
    print("5. ë…¸ì´ì¦ˆ ë° ê·¸ë¼ë°ì´ì…˜ ë°°ê²½ ìƒì„±")

# ì‚¬ìš© ì˜ˆì‹œ
if __name__ == "__main__":
    print("=" * 80)
    print("ğŸ¿ ê³¼ì íƒì§€ ëª¨ë¸ í›ˆë ¨ ì‹œì‘! (ë°°ê²½ ë‹¤ì–‘í™” & ì„±ëŠ¥ ìµœì í™”)")
    print("=" * 80)

    # í˜„ì¬ ì‘ì—… ë””ë ‰í† ë¦¬ í™•ì¸
    current_dir = os.getcwd()
    print(f"ğŸ“‚ í˜„ì¬ ì‘ì—… ë””ë ‰í† ë¦¬: {current_dir}")

    # ë¶„í• ëœ ë°ì´í„°ì…‹ ì‚¬ìš©
    yaml_path = "snack_data_2/data.yaml"
    
    # YAML íŒŒì¼ ì¡´ì¬ í™•ì¸
    if not os.path.exists(yaml_path):
        print(f"âŒ {yaml_path} íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!")
        print("01_split_dataset.pyë¥¼ ë¨¼ì € ì‹¤í–‰í•˜ì„¸ìš”.")
        exit(1)
    
    # YAML íŒŒì¼ ë‚´ìš© í™•ì¸
    with open(yaml_path, 'r', encoding='utf-8') as f:
        config = yaml.safe_load(f)
        print(f"ğŸ“‹ ë°ì´í„°ì…‹ ì •ë³´:")
        # path í‚¤ê°€ ìˆìœ¼ë©´ ì¶œë ¥, ì—†ìœ¼ë©´ ìƒëµ
        if 'path' in config:
            print(f"   - ê²½ë¡œ: {config['path']}")
        print(f"   - í´ë˜ìŠ¤ ìˆ˜: {config['nc']}ê°œ")
        print(f"   - í›ˆë ¨: {config['train']}")
        print(f"   - ê²€ì¦: {config['val']}")
        print(f"   - í…ŒìŠ¤íŠ¸: {config['test']}")

    # ë°°ê²½ ë‹¤ì–‘í™” ì •ë³´ ì¶œë ¥
    print(f"\nğŸ¨ ë°°ê²½ ë‹¤ì–‘í™” ì„¤ì •:")
    print(f"   - ìƒ‰ìƒ ë³€í™”: ê°•í™”ë¨ (HSV ì¦ê°•)")
    print(f"   - ê¸°í•˜í•™ì  ë³€í™˜: í™•ëŒ€ë¨")
    print(f"   - ê³ ê¸‰ ì¦ê°•: ëª¨ìì´í¬, ë¯¹ìŠ¤ì—…, ë³µì‚¬-ë¶™ì—¬ë„£ê¸° í™œì„±í™”")
    print(f"   - ì •ê·œí™”: ë“œë¡­ì•„ì›ƒ ë° ëœë¤ ì§€ìš°ê¸° ì ìš©")

    # ëª¨ë¸ í¬ê¸° ì„ íƒ
    print(f"\nğŸ¤– ëª¨ë¸ í¬ê¸° ì„ íƒ:")
    print(f"1. YOLO11n (nano) - ë¹ ë¦„, ê°€ë²¼ì›€ (ì¶”ì²œ)")
    print(f"2. YOLO11s (small) - ê· í˜•")
    print(f"3. YOLO11m (medium) - ì •í™•í•¨, ë¬´ê±°ì›€")
    
    choice = input("ì„ íƒí•˜ì„¸ìš” (1-3, ê¸°ë³¸ê°’: 1): ").strip()
    
    if choice == "2":
        model_size = 's'
        epochs = 120  # ë°°ê²½ ë‹¤ì–‘í™”ë¡œ ì¸í•´ ë” ë§ì€ ì—í¬í¬ í•„ìš”
        print("âœ… YOLO11s ì„ íƒ")
    elif choice == "3":
        model_size = 'm'  
        epochs = 100  # ë°°ê²½ ë‹¤ì–‘í™”ë¡œ ì¸í•´ ë” ë§ì€ ì—í¬í¬ í•„ìš”
        print("âœ… YOLO11m ì„ íƒ")
    else:  # ê¸°ë³¸ê°’ ë˜ëŠ” "1"
        model_size = 'n'
        epochs = 10  # ë°°ê²½ ë‹¤ì–‘í™”ë¡œ ì¸í•´ ë” ë§ì€ ì—í¬í¬ í•„ìš”
        print("âœ… YOLO11n ì„ íƒ (ì¶”ì²œ)")

    print(f"ğŸ”„ ì—í¬í¬: {epochs} (ë°°ê²½ ë‹¤ì–‘í™” ê³ ë ¤)")
    
    # í›ˆë ¨ ì‹œê°„ ì˜ˆìƒ (GT 1030 ê¸°ì¤€, ë°°ê²½ ë‹¤ì–‘í™”ë¡œ ì¸í•œ ì‹œê°„ ì¦ê°€)
    if model_size == 'n':
        time_estimate = "25-40ë¶„"
    elif model_size == 's':
        time_estimate = "40-60ë¶„"
    else:
        time_estimate = "60-90ë¶„"
    
    print(f"\nâš ï¸  GT 1030 ê¸°ì¤€ í›ˆë ¨ ì‹œê°„ ì˜ˆìƒ: {time_estimate}")
    print(f"ğŸ’¡ ë°°ê²½ ë‹¤ì–‘í™”ë¡œ ì¸í•´ ê¸°ì¡´ë³´ë‹¤ ì‹œê°„ì´ ë” ì†Œìš”ë©ë‹ˆë‹¤.")
    print(f"ğŸ¨ í•˜ì§€ë§Œ ë‹¤ì–‘í•œ í™˜ê²½ì—ì„œ ë” ê²¬ê³ í•œ ì„±ëŠ¥ì„ ë³´ì¼ ê²ƒì…ë‹ˆë‹¤!")
    
    # ë°°ê²½ ë‹¤ì–‘í™” ë°©ë²• ì œì•ˆ
    suggest_background_augmentation()
    
    confirm = input("\në°°ê²½ ë‹¤ì–‘í™” í›ˆë ¨ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/N): ").strip().lower()
    
    if confirm not in ['y', 'yes']:
        print("âŒ í›ˆë ¨ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.")
        exit(0)

    try:
        # ëª¨ë¸ í›ˆë ¨ ì‹¤í–‰
        model, results = train_improved_yolo11(
            data_yaml_path=yaml_path,
            model_size=model_size,
            epochs=epochs,
            imgsz=640
        )

        print(f"\nğŸŠ ë°°ê²½ ë‹¤ì–‘í™” í›ˆë ¨ ì™„ë£Œ!")
        print(f"ğŸ“ ê²°ê³¼ í™•ì¸: snack_detection/yolo11{model_size}_background_improved/ í´ë”")
        print(f"ğŸ† ìµœê³  ëª¨ë¸: weights/best.pt")
        
        print(f"\nğŸ“‹ ë‹¤ìŒ ë‹¨ê³„:")
        print(f"1. train_batch*.jpgì—ì„œ ë°°ê²½ ë‹¤ì–‘í™” í™•ì¸")
        print(f"2. ë‹¤ì–‘í•œ ë°°ê²½ì—ì„œ 04_1_yolomodel_test.pyë¡œ í…ŒìŠ¤íŠ¸")
        print(f"3. í°ìƒ‰ ì™¸ ë°°ê²½ì—ì„œ ì„±ëŠ¥ ê²€ì¦")
        print(f"4. í•„ìš”ì‹œ ë” ë§ì€ ë°°ê²½ ë°ì´í„° ìˆ˜ì§‘")
        
        # ë°°ê²½ ë‹¤ì–‘í™” íš¨ê³¼ ë¶„ì„ ê¶Œì¥
        print(f"\nğŸ” ë°°ê²½ ë‹¤ì–‘í™” íš¨ê³¼ ë¶„ì„:")
        print(f"- í›ˆë ¨ ì´ë¯¸ì§€ì—ì„œ ë‹¤ì–‘í•œ ìƒ‰ìƒê³¼ íŒ¨í„´ í™•ì¸")
        print(f"- ì‹¤ì œ í™˜ê²½(ìƒ‰ìƒ ìˆëŠ” ë°°ê²½)ì—ì„œ í…ŒìŠ¤íŠ¸ í•„ìˆ˜")
        print(f"- ì„±ëŠ¥ ì €í•˜ ì‹œ ë°°ê²½ ë°ì´í„° ì¶”ê°€ ìˆ˜ì§‘ ê¶Œì¥")
        
    except Exception as e:
        print(f"âŒ í›ˆë ¨ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
        print("ğŸ’¡ GPU ë©”ëª¨ë¦¬ ë¶€ì¡± ì‹œ ëª¨ë¸ í¬ê¸°ë¥¼ ì¤„ì´ê±°ë‚˜ ë°°ì¹˜ í¬ê¸°ë¥¼ ì¡°ì •í•˜ì„¸ìš”.")
        print("ğŸ¨ ë°°ê²½ ë‹¤ì–‘í™”ë¡œ ì¸í•œ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ì¦ê°€ë¥¼ ê³ ë ¤í•˜ì„¸ìš”.")
        exit(1)